<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥ä»»å‹™é›†é» App (æœ¬åœ°å„²å­˜ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Google Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- è¼‰å…¥ React, ReactDOM å’Œ Babel å‡½å¼åº« -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* æ‡‰ç”¨ Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ç¢ºä¿å‹•ç•«æ•ˆæœåœ¨ Tailwind ä¹‹å¤–ä¹Ÿèƒ½é †åˆ©é‹è¡Œ */
        @keyframes pulse-once {
            0% { opacity: 1; transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            50% { opacity: 0.9; transform: scale(1.03); box-shadow: 0 0 10px 10px rgba(251, 191, 36, 0.4); }
            100% { opacity: 1; transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }
        /* æ›´æ”¹ç‚ºä¸€å€‹é€šç”¨çš„é¡åˆ¥ï¼Œç”± React æ§åˆ¶å•Ÿå‹• */
        .animate-pulse-once-controlled {
            animation: pulse-once 1.5s cubic-bezier(0.4, 0, 0.6, 1) 1;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- React æ‡‰ç”¨ç¨‹å¼å°‡æ¸²æŸ“åˆ°æ­¤è™• -->
    </div>

    <!-- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (ä½¿ç”¨ Babel è™•ç† JSX) -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- å¸¸æ•¸å’Œå·¥å…·å‡½æ•¸ ---
        const initialDailyTasks = [
            { id: 1, task: "æ•´ç†ç©å…· (Tidy up toys)", points: 10 },
            { id: 2, task: "è‡ªå·±åˆ·ç‰™ (Brush teeth alone)", points: 5 },
            { id: 3, task: "å¹«å¿™æ“ºç¢— (Help set the table)", points: 15 },
            { id: 4, task: "ç¡å‰é–±è®€ 15 åˆ†é˜ (Read for 15 min)", points: 20 },
        ];

        /**
         * å–å¾—ç•¶å‰æ—¥æœŸçš„ YYYY-MM-DD æ ¼å¼å­—ä¸²
         */
        const getTodayDate = () => {
            return new Date().toISOString().split('T')[0];
        };

        /**
         * å¾ localStorage è¼‰å…¥æ•¸æ“šï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­å€¼
         */
        const loadDataFromLocalStorage = (siblingId, siblingName) => {
            const storedData = localStorage.getItem(`points_app_${siblingId}`);
            const today = getTodayDate();
            
            let data;
            if (storedData) {
                data = JSON.parse(storedData);
            } else {
                data = {
                    name: siblingName,
                    totalPoints: 0, 
                    dailyTasks: initialDailyTasks.map(task => ({...task, isCompleted: false})),
                    lastUpdated: today,
                };
            }
            
            // æ¯æ—¥é‡ç½®é‚è¼¯
            if (data.lastUpdated !== today) {
                data.dailyTasks = initialDailyTasks.map(t => ({ ...t, isCompleted: false }));
                data.lastUpdated = today;
                // æ³¨æ„ï¼šé€™è£¡åªæ›´æ–° data è®Šæ•¸ï¼Œç¨å¾Œæœƒåœ¨ useEffect ä¸­å„²å­˜
            } else if (data.dailyTasks.length !== initialDailyTasks.length) {
                // å¦‚æœä»»å‹™åˆ—è¡¨æœ‰è®Šå‹•ï¼Œå‰‡é€²è¡ŒåŒæ­¥ (ä¿ç•™å®Œæˆç‹€æ…‹ï¼Œä½†ä»¥æ–°çš„åˆ—è¡¨ç‚ºä¸»)
                const completedTaskIds = new Set(data.dailyTasks.filter(t => t.isCompleted).map(t => t.id));
                data.dailyTasks = initialDailyTasks.map(t => ({
                    ...t,
                    isCompleted: completedTaskIds.has(t.id)
                }));
            }
            
            return data;
        };

        /**
         * å„²å­˜æ•¸æ“šåˆ° localStorage
         */
        const saveDataToLocalStorage = (siblingId, data) => {
            localStorage.setItem(`points_app_${siblingId}`, JSON.stringify(data));
        };


        // --- ä¸»è¦æ‡‰ç”¨ç¨‹å¼çµ„ä»¶ ---

        const App = () => {
            const [selectedSibling, setSelectedSibling] = useState(null);
            const [error, setError] = useState(null);

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 sm:p-8 font-inter">
                    <header className="w-full max-w-4xl text-center mb-4">
                        <h1 className="text-4xl font-extrabold text-indigo-700 tracking-tight">
                            å…’ç«¥ä»»å‹™é›†é» App
                        </h1>
                        <p className="text-sm mt-1 p-1 rounded-full font-medium bg-blue-100 text-blue-700">
                            ğŸ’¾ æœ¬åœ°å„²å­˜æ¨¡å¼ (ä»»å‹™èˆ‡é»æ•¸å°‡å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­)
                        </p>
                        {error && (
                            <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                                éŒ¯èª¤: {error}
                            </div>
                        )}
                    </header>

                    <main className="w-full max-w-4xl">
                        {!selectedSibling ? (
                            <HomePage setSelectedSibling={setSelectedSibling} />
                        ) : (
                            <TaskView 
                                siblingId={selectedSibling} 
                                setSelectedSibling={setSelectedSibling} 
                            />
                        )}
                    </main>
                </div>
            );
        };

        // --- å­çµ„ä»¶ï¼šé¦–é  (é¸æ“‡å§Šå§Šæˆ–å¼Ÿå¼Ÿ) ---
        const HomePage = ({ setSelectedSibling }) => {
            const SiblingCard = ({ id, name, icon }) => (
                <div 
                    onClick={() => setSelectedSibling(id)}
                    className="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-transform transform hover:scale-105 cursor-pointer flex flex-col items-center space-y-4 border-b-4 border-indigo-500"
                >
                    <div className="text-6xl">{icon}</div>
                    <h2 className="text-2xl font-bold text-gray-800">{name}</h2>
                    <p className="text-indigo-600 font-medium">é»æ“Šé€²å…¥ä»»å‹™</p>
                </div>
            );

            return (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 p-4">
                    <SiblingCard id="sister" name="ğŸ‘§ å§Šå§Š" icon="ğŸ‘‘" />
                    <SiblingCard id="brother" name="ğŸ‘¦ å¼Ÿå¼Ÿ" icon="ğŸš€" />
                </div>
            );
        };

        // --- å­çµ„ä»¶ï¼šä»»å‹™èˆ‡é»æ•¸å„€è¡¨æ¿ ---
        const TaskView = ({ siblingId, setSelectedSibling }) => {
            const siblingName = siblingId === 'sister' ? 'å§Šå§Š' : 'å¼Ÿå¼Ÿ';
            const [data, setData] = useState(() => loadDataFromLocalStorage(siblingId, siblingName));
            const [pulseTrigger, setPulseTrigger] = useState(0); 

            // 1. ç¢ºä¿æ•¸æ“šåœ¨ localStorage ä¸­ä¿æŒæœ€æ–°
            useEffect(() => {
                saveDataToLocalStorage(siblingId, data);
            }, [data, siblingId]);

            // 2. è™•ç†æ¯æ—¥é‡ç½®å’Œç”¨æˆ¶åˆ‡æ›
            useEffect(() => {
                // ç•¶ siblingId æ”¹è®Šæ™‚ï¼Œé‡æ–°è¼‰å…¥è©²ç”¨æˆ¶çš„æ•¸æ“š
                setData(loadDataFromLocalStorage(siblingId, siblingName));
                
                // è¨­ç½®æ¯æ—¥é‡ç½®æª¢æŸ¥ (åœ¨ TaskView è¼‰å…¥æ™‚è§¸ç™¼ï¼Œä½†ä¸»è¦é‚è¼¯åœ¨ loadDataFromLocalStorage)
                const checkDailyReset = () => {
                    const currentData = loadDataFromLocalStorage(siblingId, siblingName);
                    if (currentData.lastUpdated !== getTodayDate()) {
                         // é‡æ–°è¼‰å…¥ï¼Œä¸¦è§¸ç™¼ loadDataFromLocalStorage é€²è¡Œé‡ç½®
                        setData(currentData);
                    }
                };

                // æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡é‡ç½®
                const interval = setInterval(checkDailyReset, 60 * 60 * 1000); 

                return () => clearInterval(interval);
            }, [siblingId]);


            // Helper function for updates
            const handleUpdate = useCallback((updaterFn) => {
                setData(prevData => {
                    if (!prevData) return null;
                    const newData = updaterFn(prevData);
                    // saveDataToLocalStorage æœƒåœ¨ useEffect ä¸­è™•ç†
                    return newData;
                });
                setPulseTrigger(p => p + 1);
            }, []);

            // ä»»å‹™å®Œæˆ
            const handleTaskComplete = useCallback((taskId, points) => {
                handleUpdate(prevData => {
                    const taskIndex = prevData.dailyTasks.findIndex(t => t.id === taskId);
                    if (taskIndex === -1 || prevData.dailyTasks[taskIndex].isCompleted) return prevData;

                    const updatedTasks = prevData.dailyTasks.map(t => 
                        t.id === taskId ? { ...t, isCompleted: true } : t
                    );
                    const newTotalPoints = (prevData.totalPoints || 0) + points;

                    return { ...prevData, dailyTasks: updatedTasks, totalPoints: newTotalPoints };
                });
            }, [handleUpdate]);

            // æ‰‹å‹•èª¿æ•´é»æ•¸
            const handleManualAdjust = useCallback((amount, type) => {
                if (amount <= 0) return;
                
                handleUpdate(prevData => {
                    const oldPoints = prevData.totalPoints || 0;
                    let finalAmount = type === 'add' ? amount : -amount;
                    // é»æ•¸æœ€ä½ç‚º 0
                    const newTotalPoints = Math.max(0, oldPoints + finalAmount);
                    return { ...prevData, totalPoints: newTotalPoints };
                });
            }, [handleUpdate]);

            if (!data) {
                // æ•¸æ“šè¼‰å…¥ä¸­æˆ–éŒ¯èª¤è™•ç†
                return (
                    <div className="flex items-center justify-center p-12">
                        <svg className="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                );
            }

            return (
                <div className="space-y-8">
                    <div className="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg border-l-8 border-indigo-500">
                        <h2 className="text-3xl font-bold text-gray-700">
                            {siblingName} çš„ä»»å‹™å„€è¡¨æ¿
                        </h2>
                        <button 
                            onClick={() => setSelectedSibling(null)}
                            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition duration-150 text-sm font-medium"
                        >
                            åˆ‡æ›ä½¿ç”¨è€…
                        </button>
                    </div>

                    {/* ç¸½é»æ•¸é¡¯ç¤ºå€ï¼šå‚³å…¥ pulseTrigger */}
                    <PointsSummary data={data} pulseTrigger={pulseTrigger} />

                    {/* æ¯æ—¥ä»»å‹™å€ */}
                    <DailyTasks 
                        tasks={data.dailyTasks} 
                        handleTaskComplete={handleTaskComplete} 
                        siblingName={siblingName}
                    />

                    {/* æ‰‹å‹•èª¿æ•´é»æ•¸å€ */}
                    <ManualPointAdjustment 
                        handleManualAdjust={handleManualAdjust} 
                    />
                </div>
            );
        };

        // --- å­çµ„ä»¶ï¼šæ¯æ—¥ä»»å‹™åˆ—è¡¨ ---
        const DailyTasks = ({ tasks, handleTaskComplete }) => (
            <div className="bg-white p-6 rounded-xl shadow-lg">
                <h3 className="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">
                    {getTodayDate()} æ¯æ—¥ä»»å‹™
                </h3>
                <ul className="space-y-3">
                    {tasks.map(task => (
                        <li key={task.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm transition duration-150 hover:bg-indigo-100">
                            <div className="flex items-center space-x-3">
                                <span className={`text-xl font-medium ${task.isCompleted ? 'text-green-600 line-through' : 'text-gray-700'}`}>
                                    {task.task}
                                </span>
                                <span className="text-sm font-semibold text-indigo-500 bg-indigo-100 px-2 py-0.5 rounded-full">
                                    +{task.points} é»
                                </span>
                            </div>
                            {task.isCompleted ? (
                                <span className="text-green-600 font-bold flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    å®Œæˆ
                                </span>
                            ) : (
                                <button
                                    onClick={() => handleTaskComplete(task.id, task.points)}
                                    className="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full shadow-md hover:bg-indigo-600 transition duration-200 active:translate-y-0.5"
                                >
                                    æ‰“å¡
                                </button>
                            )}
                        </li>
                    ))}
                </ul>
            </div>
        );

        // --- å­çµ„ä»¶ï¼šç¸½é»æ•¸ç¸½çµ (æ–°å¢å‹•ç•«é‚è¼¯) ---
        const PointsSummary = ({ data, pulseTrigger }) => {
            const [animateClass, setAnimateClass] = useState('');
            const currentMonth = new Date().toLocaleString('zh-TW', { year: 'numeric', month: 'long' });

            // Effect to trigger and reset the pulse animation
            useEffect(() => {
                // åªæœ‰åœ¨ pulseTrigger è®ŠåŒ–æ™‚æ‰åŸ·è¡Œ
                if (pulseTrigger > 0) {
                    // 1. æ‡‰ç”¨å‹•ç•«é¡åˆ¥
                    setAnimateClass('animate-pulse-once-controlled');
                    
                    // 2. åœ¨å‹•ç•«çµæŸå¾Œç§»é™¤é¡åˆ¥ (å‹•ç•«æŒçºŒ 1.5s)
                    const timer = setTimeout(() => {
                        setAnimateClass('');
                    }, 1500);

                    return () => clearTimeout(timer);
                }
            }, [pulseTrigger]);


            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-amber-500 transition-all duration-300">
                    <h3 className="text-2xl font-bold text-amber-700 border-b pb-3 mb-4">
                        ç•¶å‰ç´¯ç©ç¸½é»æ•¸
                    </h3>
                    <div className="text-center py-4">
                        <p className="text-lg font-medium text-gray-700">
                            ç¸½ç©åˆ†ï¼š
                        </p>
                        {/* æ‡‰ç”¨å‹•æ…‹å‹•ç•«é¡åˆ¥ */}
                        <p className={`text-6xl font-extrabold text-amber-600 ${animateClass}`}>
                            {data.totalPoints} é»
                        </p>
                        <p className="text-sm text-gray-500 mt-3">
                            é€™æ˜¯æ‚¨åœ¨ {currentMonth} ç´¯ç©çš„æ‰€æœ‰é»æ•¸ï¼Œå¯ç”¨ä¾†å…Œæ›çå‹µï¼
                        </p>
                    </div>
                </div>
            );
        };

        // --- å­çµ„ä»¶ï¼šæ‰‹å‹•é»æ•¸èª¿æ•´å€ ---
        const ManualPointAdjustment = ({ handleManualAdjust }) => {
            const [amount, setAmount] = useState('');
            const amountInt = parseInt(amount) || 0;
            
            const handleInput = (e) => {
                // åªå…è¨±æ•¸å­—è¼¸å…¥ï¼Œä¸¦é™åˆ¶é•·åº¦
                const value = e.target.value.replace(/[^0-9]/g, '');
                setAmount(value.slice(0, 3));
            };

            const handleAdjust = (type) => {
                if (amountInt > 0) {
                    handleManualAdjust(amountInt, type);
                    setAmount(''); // èª¿æ•´å¾Œæ¸…é™¤è¼¸å…¥
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <h3 className="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">
                        æ‰‹å‹•é»æ•¸èª¿æ•´ (ç®¡ç†å“¡åŠŸèƒ½)
                    </h3>
                    <div className="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
                        <input
                            type="number"
                            value={amount}
                            onChange={handleInput}
                            placeholder="é»æ•¸æ•¸é‡ (1-999)"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 text-lg text-center"
                            min="1"
                            max="999"
                        />
                        <button
                            onClick={() => handleAdjust('add')}
                            disabled={amountInt <= 0}
                            className="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed active:translate-y-0.5 whitespace-nowrap"
                        >
                            â• å¢åŠ 
                        </button>
                        <button
                            onClick={() => handleAdjust('subtract')}
                            disabled={amountInt <= 0}
                            className="w-full sm:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed active:translate-y-0.5 whitespace-nowrap"
                        >
                            â– æ‰£é™¤
                        </button>
                    </div>
                    <p className="text-xs text-gray-400 mt-3 text-center">
                        é»æ•¸æœ€ä½ç‚º 0ï¼Œæ‰£é™¤æ™‚ä¸æœƒè®Šæˆè² æ•¸ã€‚
                    </p>
                </div>
            );
        };


        // --- æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼ ---
        const rootElement = document.getElementById('root');
        ReactDOM.createRoot(rootElement).render(<App />);

    </script>
</body>
</html>