import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, doc, onSnapshot, setDoc, 
  collection, runTransaction 
} from 'firebase/firestore';

// --- å…¨åŸŸè®Šæ•¸å’Œ Firebase åˆå§‹åŒ– ---

// æ‡‰ç”¨ç¨‹å¼ ID (ç”± Canvas ç’°å¢ƒæä¾›)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chore-tracker-app';
// Firebase è¨­å®š (ç”± Canvas ç’°å¢ƒæä¾›)
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
// åˆå§‹èªè­‰ä»¤ç‰Œ (ç”± Canvas ç’°å¢ƒæä¾›)
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
let app;
let db;
let auth;

// è¨­ç½®æ—¥èªŒç´šåˆ¥ï¼Œæ–¹ä¾¿èª¿è©¦
if (Object.keys(firebaseConfig).length > 0) {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } catch (error) {
    console.error("Firebase initialization failed:", error);
  }
} else {
  console.warn("Firebase configuration not found. App will run in mock mode.");
}

// åˆå§‹ä»»å‹™è¨­å®š (çµ¦å§Šå§Šå’Œå¼Ÿå¼Ÿä½¿ç”¨)
const initialDailyTasks = [
  { id: 1, task: "æ•´ç†ç©å…· (Tidy up toys)", points: 10 },
  { id: 2, task: "è‡ªå·±åˆ·ç‰™ (Brush teeth alone)", points: 5 },
  { id: 3, task: "å¹«å¿™æ“ºç¢— (Help set the table)", points: 15 },
  { id: 4, task: "ç¡å‰é–±è®€ 15 åˆ†é˜ (Read for 15 min)", points: 20 },
];

/**
 * å–å¾—ç•¶å‰æ—¥æœŸçš„ YYYY-MM-DD æ ¼å¼å­—ä¸²
 * @returns {string} æ ¼å¼åŒ–çš„æ—¥æœŸå­—ä¸²
 */
const getTodayDate = () => {
  return new Date().toISOString().split('T')[0];
};

/**
 * å–å¾— Firestore å…¬å…±è³‡æ–™çš„åƒè€ƒè·¯å¾‘
 * @param {string} docId - æ–‡ä»¶ID ('sister' æˆ– 'brother')
 * @returns {import('firebase/firestore').DocumentReference} æ–‡ä»¶åƒè€ƒ
 */
const getCheckinDocRef = (docId) => {
  // å…¬å…±è³‡æ–™è·¯å¾‘: /artifacts/{appId}/public/data/checkinData/{docId}
  const collectionPath = `/artifacts/${appId}/public/data/checkinData`;
  return doc(db, collectionPath, docId);
};

// --- ä¸»è¦æ‡‰ç”¨ç¨‹å¼çµ„ä»¶ ---

const App = () => {
  const [user, setUser] = useState(null); // Firebase User å°è±¡
  const [userId, setUserId] = useState(null); // èªè­‰å¾Œçš„ UID æˆ–éš¨æ©Ÿ ID
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [selectedSibling, setSelectedSibling] = useState(null); // 'sister' or 'brother'
  const [error, setError] = useState(null);

  // 1. èªè­‰è™•ç†
  useEffect(() => {
    if (!auth) {
      console.error("Firebase Auth not initialized.");
      setIsAuthReady(true);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        setUserId(currentUser.uid);
      } else {
        // å˜—è©¦ä½¿ç”¨è‡ªå®šç¾©ä»¤ç‰Œç™»å…¥æˆ–åŒ¿åç™»å…¥
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            const anonymousUser = await signInAnonymously(auth);
            setUserId(anonymousUser.user.uid);
          }
        } catch (e) {
          console.error("Authentication failed:", e);
          // åŒ¿åç™»å…¥å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ ID ä½œç‚º fallback
          setUserId(crypto.randomUUID()); 
        }
      }
      setIsAuthReady(true);
    });

    return () => unsubscribe();
  }, [initialAuthToken]);


  // æ¸²æŸ“ç™»å…¥ä»‹é¢
  if (!isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <div className="text-center p-8 bg-white rounded-xl shadow-lg">
          <svg className="animate-spin h-8 w-8 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p className="text-gray-600">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    );
  }

  // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 sm:p-8 font-inter">
      <header className="w-full max-w-4xl text-center mb-8">
        <h1 className="text-4xl font-extrabold text-indigo-700 tracking-tight">
          å…’ç«¥ä»»å‹™é›†é» App (é»æ•¸ç‰ˆ)
        </h1>
        <p className="text-sm text-gray-500 mt-1">ä½¿ç”¨è€… ID: {userId || 'åŒ¿å'}</p>
        {error && (
          <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            éŒ¯èª¤: {error}
          </div>
        )}
      </header>

      <main className="w-full max-w-4xl">
        {!selectedSibling ? (
          <HomePage setSelectedSibling={setSelectedSibling} />
        ) : (
          <TaskView 
            siblingId={selectedSibling} 
            setSelectedSibling={setSelectedSibling} 
            db={db} 
            setError={setError}
            getCheckinDocRef={getCheckinDocRef}
          />
        )}
      </main>
    </div>
  );
};

// --- å­çµ„ä»¶ï¼šé¦–é  (é¸æ“‡å§Šå§Šæˆ–å¼Ÿå¼Ÿ) ---

const HomePage = ({ setSelectedSibling }) => {
  const SiblingCard = ({ id, name, icon }) => (
    <div 
      onClick={() => setSelectedSibling(id)}
      className="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-transform transform hover:scale-105 cursor-pointer flex flex-col items-center space-y-4 border-b-4 border-indigo-500"
    >
      <div className="text-6xl">{icon}</div>
      <h2 className="text-2xl font-bold text-gray-800">{name}</h2>
      <p className="text-indigo-600 font-medium">é»æ“Šé€²å…¥ä»»å‹™</p>
    </div>
  );

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 p-4">
      <SiblingCard id="sister" name="ğŸ‘§ å§Šå§Š" icon="ğŸ‘‘" />
      <SiblingCard id="brother" name="ğŸ‘¦ å¼Ÿå¼Ÿ" icon="ğŸš€" />
    </div>
  );
};

// --- å­çµ„ä»¶ï¼šä»»å‹™èˆ‡é»æ•¸å„€è¡¨æ¿ ---

const TaskView = ({ siblingId, setSelectedSibling, db, setError, getCheckinDocRef }) => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalContent, setModalContent] = useState({});

  const siblingName = siblingId === 'sister' ? 'å§Šå§Š' : 'å¼Ÿå¼Ÿ';
  const docRef = db ? getCheckinDocRef(siblingId) : null;

  // 2. è³‡æ–™åŒæ­¥èˆ‡æ¯æ—¥é‡ç½®é‚è¼¯
  useEffect(() => {
    if (!docRef) {
      // Mock Data Mode
      console.warn("Running in mock data mode.");
      setData({
        name: siblingName,
        totalPoints: 50, // Mock initial points
        dailyTasks: initialDailyTasks.map(task => ({...task, isCompleted: false})),
        lastUpdated: getTodayDate(),
      });
      setLoading(false);
      return;
    }

    const today = getTodayDate();

    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const currentData = docSnap.data();
        let newData = currentData;
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ¯æ—¥é‡ç½®
        if (currentData.lastUpdated !== today) {
          console.log("Resetting daily tasks.");
          newData = {
            ...currentData,
            dailyTasks: currentData.dailyTasks.map(t => ({ ...t, isCompleted: false })),
            lastUpdated: today,
          };
          // åŸ·è¡Œå¯«å…¥ä»¥æ›´æ–°é‡ç½®å¾Œçš„ç‹€æ…‹
          setDoc(docRef, newData, { merge: true }).catch(err => {
            console.error("Failed to reset daily tasks:", err);
            setError(`é‡ç½®ä»»å‹™å¤±æ•—: ${err.message}`);
          });
        }
        
        // ç¢ºä¿ totalPoints å­˜åœ¨ (é¦–æ¬¡è¼‰å…¥èˆŠè³‡æ–™æ™‚å¯èƒ½æ²’æœ‰)
        if (typeof newData.totalPoints !== 'number') {
            newData.totalPoints = 0;
        }

        setData(newData);
      } else {
        // åˆå§‹åŒ–è³‡æ–™
        console.log("Initializing new document.");
        const initialData = {
          name: siblingName,
          totalPoints: 0, // åˆå§‹é»æ•¸
          dailyTasks: initialDailyTasks.map(task => ({...task, isCompleted: false})),
          lastUpdated: today,
        };
        setDoc(docRef, initialData).catch(err => {
          console.error("Failed to initialize document:", err);
          setError(`åˆå§‹åŒ–è³‡æ–™å¤±æ•—: ${err.message}`);
        });
        setData(initialData);
      }
      setLoading(false);
    }, (err) => {
      console.error("Firestore subscription error:", err);
      setError(`è³‡æ–™åŒæ­¥éŒ¯èª¤: ${err.message}`);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [docRef, siblingId, setError]);

  // è™•ç†ä»»å‹™å®Œæˆ (å¢åŠ é»æ•¸)
  const handleTaskComplete = useCallback(async (taskId, points) => {
    if (!data || !docRef) return;

    const taskIndex = data.dailyTasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1 || data.dailyTasks[taskIndex].isCompleted) return;

    try {
      await runTransaction(db, async (transaction) => {
        const docSnap = await transaction.get(docRef);
        if (!docSnap.exists()) throw "Document does not exist!";
        
        const current = docSnap.data();
        const updatedTasks = current.dailyTasks.map(t => 
          t.id === taskId ? { ...t, isCompleted: true } : t
        );
        
        const newTotalPoints = current.totalPoints + points;

        transaction.update(docRef, {
          dailyTasks: updatedTasks,
          totalPoints: newTotalPoints,
        });
      });
      
      setModalContent({
        title: "ä»»å‹™å®Œæˆï¼",
        message: `æ­å–œ ${siblingName} å®Œæˆä»»å‹™ï¼Œç²å¾— ${points} é»ï¼`,
        icon: "ğŸ‰",
        color: "bg-green-500",
      });
      setIsModalOpen(true);

    } catch (e) {
      console.error("Task completion failed:", e);
      setError(`ä»»å‹™æ›´æ–°å¤±æ•—: ${e.message}`);
    }
  }, [data, docRef, siblingName, setError, db]);

  // è™•ç†æ‰‹å‹•èª¿æ•´é»æ•¸
  const handleManualAdjust = useCallback(async (amount, type) => {
    if (!data || !docRef || amount <= 0) return;
    
    try {
      await runTransaction(db, async (transaction) => {
        const docSnap = await transaction.get(docRef);
        if (!docSnap.exists()) throw "Document does not exist!";
        
        const current = docSnap.data();
        const oldPoints = current.totalPoints || 0;
        let finalAmount = type === 'add' ? amount : -amount;
        
        const newTotalPoints = Math.max(0, oldPoints + finalAmount); // ç¢ºä¿é»æ•¸ä¸ä½æ–¼ 0
        
        transaction.update(docRef, {
          totalPoints: newTotalPoints,
        });

        setModalContent({
            title: type === 'add' ? "é»æ•¸å¢åŠ " : "é»æ•¸æ‰£é™¤",
            message: `${siblingName} çš„é»æ•¸å·²æ›´æ–°: ${oldPoints} -> ${newTotalPoints} (${type === 'add' ? '+' : '-'} ${amount} é»)`,
            icon: type === 'add' ? "â•" : "â–",
            color: type === 'add' ? "bg-blue-500" : "bg-red-500",
        });
        setIsModalOpen(true);
      });
    } catch (e) {
      console.error("Manual adjustment failed:", e);
      setError(`æ‰‹å‹•èª¿æ•´é»æ•¸å¤±æ•—: ${e.message}`);
    }
  }, [data, docRef, siblingName, setError, db]);


  if (loading || !data) {
    return (
      <div className="flex items-center justify-center p-12">
        <svg className="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    );
  }

  return (
    <div className="space-y-8">
      <div className="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg border-l-8 border-indigo-500">
        <h2 className="text-3xl font-bold text-gray-700">
          {siblingName} çš„ä»»å‹™å„€è¡¨æ¿
        </h2>
        <button 
          onClick={() => setSelectedSibling(null)}
          className="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition duration-150 text-sm font-medium"
        >
          åˆ‡æ›ä½¿ç”¨è€…
        </button>
      </div>

      {/* ç¸½é»æ•¸é¡¯ç¤ºå€ */}
      <PointsSummary data={data} />

      {/* æ¯æ—¥ä»»å‹™å€ */}
      <DailyTasks 
        tasks={data.dailyTasks} 
        handleTaskComplete={handleTaskComplete} 
        siblingName={siblingName}
      />

      {/* æ‰‹å‹•èª¿æ•´é»æ•¸å€ */}
      <ManualPointAdjustment 
        handleManualAdjust={handleManualAdjust} 
      />
      
      {/* è‡ªå®šç¾© Modal è¨Šæ¯ */}
      <CustomModal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        content={modalContent} 
      />
    </div>
  );
};

// --- å­çµ„ä»¶ï¼šæ¯æ—¥ä»»å‹™åˆ—è¡¨ ---

const DailyTasks = ({ tasks, handleTaskComplete, siblingName }) => (
  <div className="bg-white p-6 rounded-xl shadow-lg">
    <h3 className="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">
      {getTodayDate()} æ¯æ—¥ä»»å‹™
    </h3>
    <ul className="space-y-3">
      {tasks.map(task => (
        <li key={task.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm transition duration-150 hover:bg-indigo-100">
          <div className="flex items-center space-x-3">
            <span className={`text-xl font-medium ${task.isCompleted ? 'text-green-600 line-through' : 'text-gray-700'}`}>
              {task.task}
            </span>
            <span className="text-sm font-semibold text-indigo-500 bg-indigo-100 px-2 py-0.5 rounded-full">
              +{task.points} é»
            </span>
          </div>
          {task.isCompleted ? (
            <span className="text-green-600 font-bold flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              å®Œæˆ
            </span>
          ) : (
            <button
              onClick={() => handleTaskComplete(task.id, task.points)}
              className="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full shadow-md hover:bg-indigo-600 transition duration-200 active:translate-y-0.5"
            >
              æ‰“å¡
            </button>
          )}
        </li>
      ))}
    </ul>
  </div>
);

// --- å­çµ„ä»¶ï¼šç¸½é»æ•¸ç¸½çµ (å–ä»£æœˆçµç®—å’Œçç« é¡¯ç¤º) ---
const PointsSummary = ({ data }) => {
  const currentMonth = new Date().toLocaleString('zh-TW', { year: 'numeric', month: 'long' });

  return (
    <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-amber-500">
      <h3 className="text-2xl font-bold text-amber-700 border-b pb-3 mb-4">
        ç•¶å‰ç´¯ç©ç¸½é»æ•¸
      </h3>
      <div className="text-center py-4">
        <p className="text-lg font-medium text-gray-700">
          ç¸½ç©åˆ†ï¼š
        </p>
        {/* ä½¿ç”¨ pulse å‹•ç•«å¼·èª¿é»æ•¸æ˜¯çå‹µçš„æ ¸å¿ƒ */}
        <p className="text-6xl font-extrabold text-amber-600 animate-pulse">
          {data.totalPoints} é»
        </p>
        <p className="text-sm text-gray-500 mt-3">
          é€™æ˜¯æ‚¨åœ¨ {currentMonth} ç´¯ç©çš„æ‰€æœ‰é»æ•¸ï¼Œå¯ç”¨ä¾†å…Œæ›çå‹µï¼
        </p>
      </div>
    </div>
  );
};

// --- å­çµ„ä»¶ï¼šæ‰‹å‹•é»æ•¸èª¿æ•´å€ ---
const ManualPointAdjustment = ({ handleManualAdjust }) => {
  const [amount, setAmount] = useState('');
  // ç¢ºä¿ amount æ°¸é æ˜¯æ•¸å­— (0 æˆ–æ­£æ•´æ•¸)
  const amountInt = parseInt(amount) || 0;
  
  const handleInput = (e) => {
    // é™åˆ¶åªèƒ½è¼¸å…¥æ•¸å­—ä¸”ä¸èƒ½è¶…é 999
    const value = e.target.value.replace(/[^0-9]/g, '');
    setAmount(value.slice(0, 3));
  };

  const handleAdjust = (type) => {
    if (amountInt > 0) {
      handleManualAdjust(amountInt, type);
      setAmount(''); // èª¿æ•´å¾Œæ¸…ç©ºè¼¸å…¥
    }
  };

  return (
    <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
      <h3 className="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">
        æ‰‹å‹•é»æ•¸èª¿æ•´ (ç®¡ç†å“¡åŠŸèƒ½)
      </h3>
      <div className="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
        <input
          type="number"
          value={amount}
          onChange={handleInput}
          placeholder="é»æ•¸æ•¸é‡ (1-999)"
          className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 text-lg text-center"
          min="1"
          max="999"
        />
        <button
          onClick={() => handleAdjust('add')}
          disabled={amountInt <= 0}
          className="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed active:translate-y-0.5 whitespace-nowrap"
        >
          â• å¢åŠ 
        </button>
        <button
          onClick={() => handleAdjust('subtract')}
          disabled={amountInt <= 0}
          className="w-full sm:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed active:translate-y-0.5 whitespace-nowrap"
        >
          â– æ‰£é™¤
        </button>
      </div>
      <p className="text-xs text-gray-400 mt-3 text-center">
        é»æ•¸æœ€ä½ç‚º 0ï¼Œæ‰£é™¤æ™‚ä¸æœƒè®Šæˆè² æ•¸ã€‚
      </p>
    </div>
  );
};


// --- å­çµ„ä»¶ï¼šè‡ªå®šç¾© Modal (å–ä»£ alert) ---
const CustomModal = ({ isOpen, onClose, content }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div 
        className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100"
        onClick={e => e.stopPropagation()} // é˜»æ­¢é»æ“Š Modal å…§å®¹æ™‚é—œé–‰
      >
        <div className={`flex items-center justify-center h-16 w-16 rounded-full mx-auto mb-4 ${content.color || 'bg-blue-500'}`}>
          <span className="text-3xl">{content.icon || 'âœ¨'}</span>
        </div>
        <h3 className="text-xl font-bold text-center mb-2 text-gray-800">
          {content.title}
        </h3>
        <p className="text-center text-gray-600 mb-6">
          {content.message}
        </p>
        <button 
          onClick={onClose}
          className={`w-full py-3 rounded-full font-semibold text-white transition duration-150 
            ${content.color ? content.color.replace('bg-', 'bg-') : 'bg-indigo-500 hover:bg-indigo-600'} 
            ${content.color ? content.color.replace('bg-', 'hover:bg-') : ''}
          `}
        >
          çŸ¥é“äº†
        </button>
      </div>
    </div>
  );
};

// åŒ¯å‡º App çµ„ä»¶
export default App;